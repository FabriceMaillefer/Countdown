@using System.Net
@using System.Net.Sockets
@using QRCoder
@using System.IO
@page "/Remote"

<div class="main-container">
    <a href="/">Vue présentateur</a>

    <div class="container">
        <h4>Scanne le QR Code pour accéder à l'application</h4>
        <p>ou alors va sur <a href="@RemoteUrl">@RemoteUrl</a></p>
        <img src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(_qrCodeByteArray))" height="300" width="300"/>  
    </div>
</div>
@code {
    protected string _localIpAddress;
    protected byte[] _qrCodeByteArray;

    protected string RemoteUrl => $"http://{_localIpAddress}:5000";

    protected override void OnInitialized()
    {
        _localIpAddress = GetLocalIPAddress();

        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode(RemoteUrl, QRCodeGenerator.ECCLevel.M);
        QRCoder.PngByteQRCode qrCode = new PngByteQRCode(qrCodeData);
        _qrCodeByteArray = qrCode.GetGraphic(20);

        base.OnInitialized();
    }

    public static string GetLocalIPAddress()
    {
        var host = Dns.GetHostEntry(Dns.GetHostName());
        foreach (var ip in host.AddressList)
        {
            if (ip.AddressFamily == AddressFamily.InterNetwork && !ip.ToString().StartsWith("127"))
            {
                return ip.ToString();
            }
        }
        return "localhost";
    }
}
